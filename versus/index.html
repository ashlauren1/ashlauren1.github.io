<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hockey Stats Site</title>
    <link rel="stylesheet" href="/assets/styles.css">
    <script src="/assets/searchBar.js"></script>
    <script src="/assets/tableSort.js"></script>
</head>
<body>

<style>
#searchResults {
    position: absolute;
    background-color: white;
    border: 1px solid #ccc;
    width: 100%;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
}

#searchResults div {
    padding: 10px;
    cursor: pointer;
}

#searchResults div:hover, .highlighted {
    background-color: #f1f1f1;
}

#searchResults a {
    text-decoration: none;
    color: black;
    display: block;
}
</style>

<!-- Navigation Bar -->
<nav id="navbar">
  <ul>
    <li><a href="/">Home</a></li>
    <li><a href="/players/">Players</a></li>
    <li><a href="/teams/">Teams</a></li>
    <li><a href="/leaders/">Leaders</a></li>
    <li><a href="/probabilities/">Probabilities</a></li>
    <li><a href="/boxscores/">Boxscores</a></li>
    <li><a href="/schedule/">Schedule</a></li>
    <!-- Search Bar -->
    <li>
      <input type="text" id="searchBar" placeholder="Search for players or teams..." oninput="performSearch()" autocomplete="off">
      <div id="searchResults" class="dropdown"></div>
      <button id="searchButton" onclick="handleSearch()">Search</button>
    </li>  
  </ul>
</nav>

<script>
let players = [];
let teams = [];
let selectedIndex = -1; // For keeping track of selected suggestion

// Fetch players and teams data
fetch('/assets/players.json')
    .then(response => response.json())
    .then(data => {
        players = data;
    })
    .catch(error => console.error('Error loading players data:', error));

fetch('/assets/teams.json')
    .then(response => response.json())
    .then(data => {
        teams = data;
    })
    .catch(error => console.error('Error loading teams data:', error));

// Handle key navigation and suggestions
document.getElementById('searchBar').addEventListener('keydown', function(event) {
    const resultsContainer = document.getElementById('searchResults');
    const suggestions = resultsContainer.querySelectorAll('div');

    if (suggestions.length === 0) return;  // Add this line to avoid errors if there are no suggestions

    if (event.key === 'ArrowDown') {
        selectedIndex = (selectedIndex + 1) % suggestions.length;
        highlightSuggestion(suggestions);
    } else if (event.key === 'ArrowUp') {
        selectedIndex = (selectedIndex - 1 + suggestions.length) % suggestions.length;
        highlightSuggestion(suggestions);
    } else if (event.key === 'Enter') {
        if (selectedIndex >= 0 && suggestions[selectedIndex]) {
            window.location.href = suggestions[selectedIndex].querySelector('a').href;
        } else {
            handleSearch();  // Perform full search if no suggestion selected
        }
        event.preventDefault();  // Prevent form submission
    }
});

function highlightSuggestion(suggestions) {
    suggestions.forEach((suggestion, index) => {
        suggestion.classList.toggle('highlighted', index === selectedIndex);
    });
}

function performSearch() {
    const input = document.getElementById('searchBar').value.toLowerCase();
    const resultsContainer = document.getElementById('searchResults');
    resultsContainer.innerHTML = ''; // Clear previous results
    selectedIndex = -1; // Reset selected suggestion index

    if (input.length === 0) {
        return; // Do nothing if input is empty
    }

    // Filter players and teams based on input
    const filteredPlayers = players.filter(player => 
        player.name.toLowerCase().startsWith(input) || player.eng_name.toLowerCase().startsWith(input)
    );

    const filteredTeams = teams.filter(team => 
        team.name.toLowerCase().startsWith(input) || team.aliases.some(alias => alias.toLowerCase().startsWith(input))
    );

    // Display suggestions for players
    filteredPlayers.forEach(player => {
        const resultItem = document.createElement('div');
        resultItem.innerHTML = "<a href="${player.url}">${player.name}</a>";
        resultItem.addEventListener('click', () => window.location.href = player.url);
        resultsContainer.appendChild(resultItem);
    });

    // Display suggestions for teams
    filteredTeams.forEach(team => {
        const resultItem = document.createElement('div');
        resultItem.innerHTML = "<a href="${team.url}">${team.name}</a>";
        resultItem.addEventListener('click', () => window.location.href = team.url);
        resultsContainer.appendChild(resultItem);
    });

    resultsContainer.style.display = 'block';
}

function handleSearch() {
    const input = document.getElementById('searchBar').value.toLowerCase();
    const resultsContainer = document.getElementById('searchResults');
    resultsContainer.innerHTML = ''; // Clear previous results

    // Filter players and teams
    const filteredPlayers = players.filter(player => 
        player.name.toLowerCase().includes(input) || player.eng_name.toLowerCase().includes(input)
    );

    const filteredTeams = teams.filter(team => 
        team.name.toLowerCase().includes(input) || team.aliases.some(alias => alias.toLowerCase().includes(input))
    );

    // Display all results on a new search results page
    let resultsHTML = '';
    filteredPlayers.forEach(player => {
        resultsHTML += "<div><a href="${player.url}">${player.name}</a></div>";
    });

    filteredTeams.forEach(team => {
        resultsHTML += "<div><a href="${team.url}">${team.name}</a></div>";
    });

    // Redirect or display the results somewhere on the page
    window.location.href = `/search-results?q=${input}`;  // Example redirect to a results page

    // Alternatively, you can append these results to a container on the same page:
    // document.getElementById('searchResultsContainer').innerHTML = resultsHTML;
}

document.addEventListener('click', function(event) {
    const searchBar = document.getElementById('searchBar');
    const resultsContainer = document.getElementById('searchResults');

    // Hide search results if clicked outside of the search bar or results
    if (!searchBar.contains(event.target) && !resultsContainer.contains(event.target)) {
        resultsContainer.style.display = 'none';
    }
});
</script>

    <h1>Advanced Head-to-Head Search</h1>
    <form id="advancedSearchForm">
        <div class="form-group">
            <label for="player1">Player 1:</label>
            <input type="text" id="player1" name="player1" placeholder="Enter Player 1 name">
        </div>
        <div class="form-group">
            <label for="player2">Player 2:</label>
            <input type="text" id="player2" name="player2" placeholder="Enter Player 2 name (optional)">
        </div>
        <div class="form-group">
            <label for="team1">Team 1:</label>
            <input type="text" id="team1" name="team1" placeholder="Enter Team 1 name">
        </div>
        <div class="form-group">
            <label for="team2">Team 2:</label>
            <input type="text" id="team2" name="team2" placeholder="Enter Team 2 name (optional)">
        </div>
        <div class="form-group">
            <label for="season">Season:</label>
            <select id="season" name="season">
                <option value="all">All Seasons</option>
                <option value="2021-22">2021-22</option>
                <option value="2022-23">2022-23</option>
                <option value="2023-24">2023-24</option>
                <option value="2024-25">2024-25</option>
            </select>
        </div>
        <div class="form-group">
            <label><input type="checkbox" name="awayGamesOnly"> Away Games Only</label>
        </div>
        <div class="form-group">
            <label><input type="checkbox" name="excludeTeammates"> Exclude Specific Teammates</label>
            <input type="text" id="excludeTeammate" name="excludeTeammate" placeholder="Enter Teammate Name">
        </div>
        <button type="button" onclick="handleAdvancedSearch()">Search</button>
    </form>
    <div id="resultsContainer"></div>

    <script src="/assets/advancedSearch.js"></script>
</body>
</html>
